name: Deploy to Digital Ocean

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Verify secrets
      run: |
        if [ -z "${{ secrets.DO_HOST }}" ]; then
          echo "‚ùå DO_HOST secret is not set"
          exit 1
        fi
        if [ -z "${{ secrets.DO_USERNAME }}" ]; then
          echo "‚ùå DO_USERNAME secret is not set"
          exit 1
        fi
        if [ -z "${{ secrets.DO_SSH_KEY }}" ]; then
          echo "‚ùå DO_SSH_KEY secret is not set"
          exit 1
        fi
        echo "‚úÖ All required secrets are configured"
      
    - name: Deploy to Digital Ocean
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.DO_SSH_KEY }}
        port: 22
        timeout: 300s
        command_timeout: 600s
        script: |
          set -e
          echo "üöÄ Starting deployment at $(date)"
          
          # Check if project directory exists
          if [ ! -d "~/doctracer" ]; then
            echo "üìÅ Creating project directory..."
            mkdir -p ~/doctracer
            cd ~/doctracer
            git clone https://github.com/Amayuru1999/doctracer.git .
          else
            echo "üìÅ Navigating to project directory..."
            cd ~/doctracer
          fi
          
          echo "üì• Pulling latest changes..."
          git fetch origin
          git reset --hard origin/main
          
          echo "üîç Checking Docker installation..."
          if ! command -v docker &> /dev/null; then
            echo "‚ùå Docker is not installed"
            exit 1
          fi
          
          if ! command -v docker-compose &> /dev/null; then
            echo "‚ùå Docker Compose is not installed"
            exit 1
          fi
          
          echo "üìã Checking environment file..."
          if [ ! -f ".env" ]; then
            if [ -f ".env.production" ]; then
              echo "üìÑ Copying .env.production to .env"
              cp .env.production .env
            else
              echo "‚ùå No .env or .env.production file found"
              exit 1
            fi
          fi
          
          echo "üõë Stopping existing containers..."
          docker-compose -f docker-compose.prod.yml down --remove-orphans || true
          
          echo "üßπ Cleaning up Docker resources..."
          docker system prune -f || true
          
          echo "üèóÔ∏è Building and starting containers..."
          docker-compose -f docker-compose.prod.yml up -d --build --force-recreate
          
          echo "‚è≥ Waiting for services to start..."
          sleep 60
          
          echo "üîç Checking container status..."
          docker-compose -f docker-compose.prod.yml ps
          
          echo "üìä Checking container logs..."
          docker-compose -f docker-compose.prod.yml logs --tail=10 backend || true
          
          echo "‚úÖ Deployment completed at $(date)"
          
    - name: Health Check
      run: |
        echo "üè• Running health check..."
        sleep 45
        
        # Test API endpoint
        for i in {1..5}; do
          echo "Attempt $i/5: Testing API endpoint..."
          if curl -f -s --max-time 30 "http://${{ secrets.DO_HOST }}:5001/gazettes" > /dev/null; then
            echo "‚úÖ API health check passed"
            exit 0
          fi
          echo "‚è≥ Waiting 30 seconds before retry..."
          sleep 30
        done
        
        echo "‚ùå API health check failed after 5 attempts"
        echo "üîç Checking if port 5001 is accessible..."
        nc -zv ${{ secrets.DO_HOST }} 5001 || echo "Port 5001 is not accessible"
        exit 1